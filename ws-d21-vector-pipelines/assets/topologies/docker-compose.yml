version: '3.8'
services:
  # Two Vector Agents emit random HTTP logs
  vector_http_logs_agent:
    image: timberio/vector:0.17.0-alpine
    deploy:
      replicas: 2
    volumes:
      - ./vector/agent/http:/etc/vector:ro
    depends_on:
      - aggregator
  # Two Vector Agents emit random Syslog logs
  vector_syslog_logs_agent:
    image: timberio/vector:0.17.0-alpine
    deploy:
      replicas: 2
    volumes:
      - ./vector/agent/syslog:/etc/vector:ro
    depends_on:
      - aggregator
  # Two Datadog Agents
  datadog_agent:
    image: gcr.io/datadoghq/agent:7
    privileged: true
    environment:
      - DD_API_KEY
    deploy:
      replicas: 2
    volumes:
      - ./datadog:/etc/datadog-agent
      - ./logs:/tmp/logs:ro
    depends_on:
      - aggregator
  fluentbit_agent:
    image: fluent/fluent-bit:1.8
    deploy:
      replicas: 2
    volumes:
      - ./fluent-bit:/fluent-bit/etc:ro
    depends_on:
      - aggregator
  aggregator:
    container_name: vector_aggregator
    image: timberio/vector:0.17.0-alpine
    ports:
      # GraphQL API for vector tap and vector top
      - 8686:8686
      # Datadog Agents
      - 8080:8080
      # Vector Agents
      - 9000:9000
      # Fluent Bit Agents
      - 24224:24224
    environment:
      LOG: info
    volumes:
      - ./vector/aggregator:/etc/vector:ro
  
  # Vector agent producing logs for the Datadog Agent
  dd_logs_producer:
    image: timberio/vector:0.17.0-alpine
    environment:
      - DD_API_KEY
    volumes:
      - ./vector/producer:/etc/vector:ro
      - ./logs:/tmp/logs
  
  # Prometheus Node Exporter
  node_exporter:
    image: prom/node-exporter:v1.2.2
    ports:
      - 9100:9100